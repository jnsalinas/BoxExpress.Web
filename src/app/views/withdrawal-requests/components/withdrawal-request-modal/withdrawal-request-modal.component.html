<c-modal
  [visible]="isVisible"
  size="lg"
  backdrop="static"
  keyboard="false"
  scrollable
>
  <c-modal-header>
    <h5 class="modal-title">
      <svg [cIcon]="icons.cilMoney" class="me-2"></svg>
      <span *ngIf="(form.value.id ?? 0) === 0">Nuevo Retiro</span>
      <span *ngIf="(form.value.id ?? 0) !== 0">Gestionar Retiro</span>
    </h5>
  </c-modal-header>

  <c-modal-body>
    <!-- Balance Info -->
    <div *ngIf="store" class="alert alert-info d-flex align-items-center mb-4">
      <svg [cIcon]="icons.cilWallet" class="me-2"></svg>
      <strong>Balance disponible: </strong>
      <span class="ms-1">{{ store.balance | currency }}</span>
    </div>

    <form [formGroup]="form">
      <!-- Store Selection (Admin only) -->
      <div class="row" *hasRole="['admin']">
        <div class="col-12 mb-3">
          <label class="form-label">
            <svg [cIcon]="icons.cilHome" class="me-1"></svg>
            Tienda
          </label>
          <ng-select
            [items]="stores"
            bindLabel="name"
            bindValue="id"
            formControlName="storeId"
            [searchable]="true"
            placeholder="Seleccione una tienda"
            (change)="onStoreChange($event)"
          >
          </ng-select>
        </div>
      </div>

      <!-- Amount and Account Holder -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">
            <svg [cIcon]="icons.cilDollar" class="me-1"></svg>
            Monto
          </label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input
              type="number"
              class="form-control"
              formControlName="amount"
              [max]="store?.balance ?? 0"
              placeholder="0.00"
              step="0.01"
            />
          </div>
          <div *ngIf="form.get('amount')?.errors?.['max']" class="text-danger small mt-1">
            <svg [cIcon]="icons.cilWarning" class="me-1"></svg>
            El monto no puede ser mayor a {{ store?.balance ?? 0 | currency }}
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label">
            <svg [cIcon]="icons.cilUser" class="me-1"></svg>
            Titular de la cuenta
          </label>
          <input
            type="text"
            class="form-control"
            formControlName="accountHolder"
            placeholder="Nombre del titular"
          />
        </div>
      </div>

      <!-- Document Information -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">
            <svg [cIcon]="icons.cilUser" class="me-1"></svg>
            Tipo de documento
          </label>
          <ng-select
            [items]="documentTypes"
            bindLabel="name"
            bindValue="id"
            formControlName="documentTypeId"
            [searchable]="false"
            placeholder="Seleccione un tipo de documento"
          >
          </ng-select>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label">
            <svg [cIcon]="icons.cilFile" class="me-1"></svg>
            Número de documento
          </label>
          <input 
            type="number" 
            class="form-control" 
            formControlName="document"
            placeholder="Número de documento"
          />
        </div>
      </div>

      <!-- Bank Information -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">
            <svg [cIcon]="icons.cilBank" class="me-1"></svg>
            Banco
          </label>
          <input 
            type="text" 
            class="form-control" 
            formControlName="bank"
            placeholder="Nombre del banco"
          />
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label">
            <svg [cIcon]="icons.cilCreditCard" class="me-1"></svg>
            Número de cuenta
          </label>
          <input
            type="number"
            class="form-control"
            formControlName="accountNumber"
            placeholder="Número de cuenta"
          />
        </div>
      </div>

      <!-- Description -->
      <div class="row">
        <div class="col-12 mb-3">
          <label class="form-label">
            <svg [cIcon]="icons.cilNotes" class="me-1"></svg>
            Descripción
          </label>
          <textarea
            class="form-control"
            formControlName="description"
            placeholder="Descripción del retiro"
            rows="3"
          ></textarea>
        </div>
      </div>

      <!-- Management (Admin only) -->
      <div class="row" *hasRole="['admin']">
        <div class="col-12 mb-3">
          <label class="form-label">
            <svg [cIcon]="icons.cilSettings" class="me-1"></svg>
            Gestión
          </label>
          <textarea 
            class="form-control" 
            formControlName="reason"
            placeholder="Comentarios de gestión"
            rows="3"
          ></textarea>
        </div>
      </div>
    </form>
  </c-modal-body>

  <c-modal-footer>
    <button class="btn btn-secondary" type="button" (click)="close()">
      <svg [cIcon]="icons.cilX" class="me-1"></svg>
      Cancelar
    </button>
    <button
      *ngIf="!isPending && (form.value.id ?? 0) === 0"
      class="btn btn-primary"
      type="button"
      (click)="save()"
      [disabled]="form.invalid"
    >
      <svg [cIcon]="icons.cilSave" class="me-1"></svg>
      Guardar
    </button>
    <button
      *ngIf="isPending"
      type="button"
      class="btn btn-success"
      (click)="approve()"
    >
      <svg [cIcon]="icons.cilCheck" class="me-1"></svg>
      Aprobar
    </button>
    <button
      *ngIf="isPending"
      type="button"
      class="btn btn-danger"
      (click)="reject()"
    >
      <svg [cIcon]="icons.cilXCircle" class="me-1"></svg>
      Rechazar
    </button>
  </c-modal-footer>
</c-modal>
