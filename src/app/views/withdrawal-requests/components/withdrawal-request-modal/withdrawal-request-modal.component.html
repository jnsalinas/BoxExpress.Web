<c-modal
  [visible]="isVisible"
  size="lg"
  backdrop="static"
  keyboard="false"
  scrollable
  class="withdrawal-modal"
>
  <c-modal-header class="modal-header-custom">
    <h5 class="modal-title">
      <div class="d-flex align-items-center">
        <div class="modal-icon me-2">
          <i class="fas fa-money-bill-wave text-primary"></i>
        </div>
        <div>
          <span *ngIf="(form.value.id ?? 0) === 0" class="fw-bold">Nuevo Retiro</span>
          <span *ngIf="(form.value.id ?? 0) !== 0" class="fw-bold">Gestionar Retiro</span>
        </div>
      </div>
    </h5>
  </c-modal-header>

  <c-modal-body class="modal-body-custom">
    <!-- Balance Info -->
    <div *ngIf="store" class="balance-info mb-3">
      <div class="d-flex align-items-center">
        <i class="fas fa-wallet text-success me-2"></i>
        <strong>Balance disponible: </strong>
        <span class="ms-1 text-success fw-bold">{{ store.balance | number:'1.0-0' }}</span>
      </div>
    </div>

    <form [formGroup]="form" class="withdrawal-form">
      <!-- Store Selection (Admin only) -->
      <div class="row mb-3" *hasRole="['admin']">
        <div class="col-12">
          <label class="form-label">
            <i class="fas fa-home me-1 text-muted"></i>
            Tienda
          </label>
          <ng-select
            [items]="stores"
            bindLabel="name"
            bindValue="id"
            formControlName="storeId"
            [searchable]="true"
            placeholder="Seleccione una tienda"
            (change)="onStoreChange($event)"
            class="custom-select"
          >
          </ng-select>
        </div>
      </div>

      <!-- Amount and Account Holder -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">
            <i class="fas fa-coins me-1 text-muted"></i>
            Monto
          </label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-dollar-sign"></i>
            </span>
            <input
              type="number"
              class="form-control"
              formControlName="amount"
              [max]="store?.balance ?? 0"
              placeholder="0"
              step="0.01"
            />
          </div>
          <div *ngIf="form.get('amount')?.errors?.['max']" class="error-message">
            <i class="fas fa-exclamation-triangle me-1"></i>
            El monto no puede ser mayor a {{ store?.balance ?? 0 | number:'1.0-0' }}
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">
            <i class="fas fa-user me-1 text-muted"></i>
            Titular de la cuenta
          </label>
          <input
            type="text"
            class="form-control"
            formControlName="accountHolder"
            placeholder="Nombre del titular"
          />
        </div>
      </div>

      <!-- Document Information -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">
            <i class="fas fa-file-alt me-1 text-muted"></i>
            Tipo de documento
          </label>
          <ng-select
            [items]="documentTypes"
            bindLabel="name"
            bindValue="id"
            formControlName="documentTypeId"
            [searchable]="false"
            placeholder="Seleccione un tipo"
            class="custom-select"
          >
          </ng-select>
        </div>

        <div class="col-md-6">
          <label class="form-label">
            <i class="fas fa-hashtag me-1 text-muted"></i>
            Número de documento
          </label>
          <input 
            type="number" 
            class="form-control" 
            formControlName="document"
            placeholder="Número de documento"
          />
        </div>
      </div>

      <!-- Bank Information -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">
            <i class="fas fa-bank me-1 text-muted"></i>
            Banco
          </label>
          <input 
            type="text" 
            class="form-control" 
            formControlName="bank"
            placeholder="Nombre del banco"
          />
        </div>

        <div class="col-md-6">
          <label class="form-label">
            <i class="fas fa-credit-card me-1 text-muted"></i>
            Número de cuenta
          </label>
          <input
            type="number"
            class="form-control"
            formControlName="accountNumber"
            placeholder="Número de cuenta"
          />
        </div>
      </div>

      <!-- Description -->
      <div class="row mb-3">
        <div class="col-12">
          <label class="form-label">
            <i class="fas fa-align-left me-1 text-muted"></i>
            Descripción
          </label>
          <textarea
            class="form-control"
            formControlName="description"
            placeholder="Describe el motivo del retiro..."
            rows="2"
          ></textarea>
        </div>
      </div>

      <!-- Management (Admin only) -->
      <div class="row mb-3" *hasRole="['admin']">
        <div class="col-12">
          <label class="form-label">
            <i class="fas fa-comments me-1 text-muted"></i>
            Comentarios de gestión
          </label>
          <textarea 
            class="form-control" 
            formControlName="reason"
            placeholder="Comentarios internos para la gestión..."
            rows="2"
          ></textarea>
        </div>
      </div>
    </form>
  </c-modal-body>

  <c-modal-footer class="modal-footer-custom">
    <div class="d-flex gap-2 w-100">
      <button class="btn btn-outline-secondary flex-fill" type="button" (click)="close()">
        <i class="fas fa-times me-1"></i>
        Cancelar
      </button>
      
      <button
        *ngIf="!isPending && (form.value.id ?? 0) === 0"
        class="btn btn-primary flex-fill"
        type="button"
        (click)="save()"
        [disabled]="form.invalid"
      >
        <i class="fas fa-save me-1"></i>
        Guardar
      </button>
      
      <button
        *ngIf="isPending"
        type="button"
        class="btn btn-success flex-fill"
        (click)="approve()"
      >
        <i class="fas fa-check me-1"></i>
        Aprobar
      </button>
      
      <button
        *ngIf="isPending"
        type="button"
        class="btn btn-danger flex-fill"
        (click)="reject()"
      >
        <i class="fas fa-times-circle me-1"></i>
        Rechazar
      </button>
    </div>
  </c-modal-footer>
</c-modal>
