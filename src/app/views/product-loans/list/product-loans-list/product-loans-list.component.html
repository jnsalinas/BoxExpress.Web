<app-loading-overlay
  *ngIf="isLoading"
  [loadingText]="'Cargando préstamos...'"
></app-loading-overlay>

<div *ngIf="!isLoading" class="product-loans-list-container">
  <!-- Header con estadísticas -->
  <c-card class="mb-3 stats-header-card">
    <c-card-body class="p-3">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="d-flex align-items-center">
            <div class="header-icon me-3">
              <svg [cIcon]="icons.cilBasket" size="2xl"></svg>
            </div>
            <div>
              <h3 class="mb-1 text-primary">Gestión Tradicional</h3>
              <p class="text-muted mb-0 small">
                Administra y monitorea todos los préstamos de productos del
                sistema
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <div class="action-buttons d-flex gap-2">
            <button
              type="button"
              class="btn btn-primary btn-sm"
              (click)="downloadExcel()"
              title="Exportar a Excel"
            >
              <svg
                [cIcon]="icons.cilCloudDownload"
                size="sm"
                class="me-1"
              ></svg>
              Exportar
            </button>
            <button
              *hasRole="['admin', 'supervisor']"
              type="button"
              class="btn btn-primary btn-sm"
              [routerLink]="['/product-loans/create']"
              title="Crear nuevo préstamo"
            >
              <svg [cIcon]="icons.cilPlus" size="sm" class="me-1"></svg>
              Nuevo Préstamo
            </button>
          </div>
        </div>
      </div>
    </c-card-body>
  </c-card>

  <!-- Filtros mejorados -->
  <c-card class="mb-3 filters-card">
    <c-card-header class="bg-light py-2">
      <h6 class="mb-0">
        <svg [cIcon]="icons.cilFilter" size="sm" class="me-2 text-info"></svg>
        Filtros de Búsqueda
      </h6>
    </c-card-header>
    <c-card-body class="py-3">
      <form
        [formGroup]="filtersForm"
        (ngSubmit)="onFilter()"
        class="filters-form"
      >
        <div class="row g-2 align-items-end">
          <div class="col-md-2">
            <label for="warehouse" class="form-label small fw-semibold mb-1">
              <svg
                [cIcon]="icons.cilHome"
                size="sm"
                class="me-1 text-muted"
              ></svg>
              Bodega
            </label>
            <ng-select
              [items]="warehouseOptions"
              bindLabel="name"
              bindValue="id"
              formControlName="warehouseId"
              [searchable]="true"
              placeholder="Seleccione bodega"
              class="custom-select"
            >
            </ng-select>
          </div>

          <div class="col-md-2">
            <label for="startDate" class="form-label small fw-semibold mb-1">
              <svg
                [cIcon]="icons.cilCalendar"
                size="sm"
                class="me-1 text-muted"
              ></svg>
              Desde
            </label>
            <input
              type="date"
              id="startDate"
              formControlName="startDate"
              class="form-control form-control-sm"
            />
          </div>

          <div class="col-md-2">
            <label for="endDate" class="form-label small fw-semibold mb-1">
              <svg
                [cIcon]="icons.cilCalendar"
                size="sm"
                class="me-1 text-muted"
              ></svg>
              Hasta
            </label>
            <input
              type="date"
              id="endDate"
              formControlName="endDate"
              class="form-control form-control-sm"
            />
          </div>

          <div class="col-md-2">
            <label for="status" class="form-label small fw-semibold mb-1">
              <svg
                [cIcon]="icons.cilTask"
                size="sm"
                class="me-1 text-muted"
              ></svg>
              Estado
            </label>
            <ng-select
              [items]="statusOptions"
              bindLabel="name"
              bindValue="id"
              formControlName="status"
              [searchable]="true"
              placeholder="Seleccione estado"
              class="custom-select"
            >
            </ng-select>
          </div>

          <div class="col-md-4">
            <div class="d-flex gap-1 w-100">
              <button type="submit" class="btn btn-primary btn-sm flex-fill">
                <svg [cIcon]="icons.cilSearch" size="sm" class="me-1"></svg>
                Buscar
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm flex-fill"
                (click)="resetFilters()"
              >
                <svg [cIcon]="icons.cilX" size="sm" class="me-1"></svg>
                Limpiar
              </button>
            </div>
          </div>
        </div>
      </form>
    </c-card-body>
  </c-card>

  <!-- Contenido principal -->
  <c-card class="main-content-card">
    <c-card-body class="p-0">
      <!-- Resumen de estados -->
      <div class="status-summary p-4">
        <h6 class="mb-2 text-muted small">
          <svg [cIcon]="icons.cilChart" size="sm" class="me-2"></svg>
          Resumen por Estado
        </h6>
        <div class="row g-2">
          <div
            class="col-md-2 col-sm-4 col-6"
            *ngFor="let status of productLoanSummary"
          >
            <c-card
              class="status-card text-center h-100"
              [ngClass]="getStatusClass(status.statusName)"
            >
              <c-card-body class="p-2">
                <div class="status-icon mb-1">
                  <svg [cIcon]="icons.cilCircle" size="sm" class="small"></svg>
                </div>
                <h6 class="mb-1 status-name small">{{ status.statusName }}</h6>
                <p class="m-0 status-count fw-bold">{{ status.count }}</p>
              </c-card-body>
            </c-card>
          </div>
        </div>
      </div>

      <!-- Tabla de préstamos -->
      <div class="product-loans-table-container p-4">
        <div class="table-responsive">
          <table class="table">
            <thead class="table-light">
              <tr>
                <th scope="col" class="text-center">
                  <svg
                    [cIcon]="icons.cilListNumbered"
                    size="sm"
                    class="text-muted"
                  ></svg>
                  ID
                </th>
                <th scope="col">
                  <svg
                    [cIcon]="icons.cilHome"
                    size="sm"
                    class="text-muted me-1"
                  ></svg>
                  Bodega
                </th>
                <th scope="col">
                  <svg
                    [cIcon]="icons.cilCalendar"
                    size="sm"
                    class="text-muted me-1"
                  ></svg>
                  Fecha
                </th>
                <th scope="col">
                  <svg
                    [cIcon]="icons.cilNotes"
                    size="sm"
                    class="text-muted me-1"
                  ></svg>
                  Notas
                </th>
                <th scope="col">
                  <svg
                    [cIcon]="icons.cilTask"
                    size="sm"
                    class="text-muted me-1"
                  ></svg>
                  Estado
                </th>
                <th scope="col" class="text-center">
                  <svg
                    [cIcon]="icons.cilCog"
                    size="sm"
                    class="text-muted"
                  ></svg>
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let loan of productLoans" class="align-middle">
                <td class="text-center">
                  <span class="badge bg-secondary">{{ loan.id }}</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <svg
                      [cIcon]="icons.cilHome"
                      size="sm"
                      class="text-primary me-2"
                    ></svg>
                    <span class="fw-medium">{{ loan.warehouseName }}</span>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <svg
                      [cIcon]="icons.cilCalendar"
                      size="sm"
                      class="text-info me-2"
                    ></svg>
                    <span>{{ loan.loanDate | date : "dd/MM/yyyy" }}</span>
                  </div>
                </td>
                <td>
                  <div class="notes-cell">
                    <span
                      class="text-truncate d-inline-block"
                      style="max-width: 200px"
                      [title]="loan.notes"
                    >
                      {{ loan.notes || "Sin notas" }}
                    </span>
                  </div>
                </td>
                <td>
                  <span
                    class="badge"
                    [ngClass]="getStatusBadgeClass(loan.status)"
                  >
                    {{ getStatusDisplayName(loan.status) }}
                  </span>
                </td>
                <td class="text-center">
                  <div class="btn-group" role="group">
                    <!-- <button
                      type="button"
                      class="btn btn-outline-primary btn-sm"
                      (click)="viewDetail(loan)"
                      title="Ver detalle"
                    >
                      <svg [cIcon]="icons.cilMagnifyingGlass" size="sm"></svg>
                    </button> -->
                    <button
                      type="button"
                      class="btn btn-outline-success btn-sm"
                      [routerLink]="['/product-loans', loan.id, 'detail']"
                      title="Gestionar préstamo"
                    >
                      <svg [cIcon]="icons.cilSettings" size="sm"></svg>
                    </button>
                    <!-- <button
                      type="button"
                      class="btn btn-outline-warning btn-sm"
                      [routerLink]="['/product-loans', loan.id, 'edit']"
                      title="Editar préstamo"
                    >
                      <svg [cIcon]="icons.cilPencil" size="sm"></svg>
                    </button> -->
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Mensaje cuando no hay datos -->
        <div *ngIf="productLoans.length === 0" class="text-center py-5">
          <svg
            [cIcon]="icons.cilInbox"
            size="sm"
            class="text-muted fs-1 mb-3"
          ></svg>
          <h5 class="text-muted">No se encontraron préstamos</h5>
          <p class="text-muted small">
            No hay préstamos que coincidan con los filtros aplicados
          </p>
        </div>

        <!-- Paginación -->
        <div class="pagination-container mt-4" *ngIf="productLoans.length > 0">
          <app-generic-pagination
            [pagination]="pagination"
            [currentPage]="currentPage"
            (pageChange)="onPageChange($event)"
          >
          </app-generic-pagination>
        </div>
      </div>
    </c-card-body>
  </c-card>
</div>

<!-- Modales -->
<app-generic-modal></app-generic-modal>
