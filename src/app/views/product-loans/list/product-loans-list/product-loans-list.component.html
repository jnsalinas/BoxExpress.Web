<app-loading-overlay
  *ngIf="isLoading"
  [loadingText]="'Cargando préstamos...'"
></app-loading-overlay>

<div *ngIf="!isLoading" class="product-loans-list-container">
  <!-- Header con estadísticas -->
  <c-card class="mb-3 stats-header-card">
    <c-card-body class="p-3">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="d-flex align-items-center">
            <div class="product-loans-icon me-3">
              <i class="fas fa-handshake text-primary fs-3"></i>
            </div>
            <div>
              <h3 class="mb-1 text-primary">Gestión Tradicional</h3>
              <p class="text-muted mb-0 small">Administra y monitorea todos los préstamos de productos del sistema</p>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <div class="action-buttons d-flex gap-2">
            <button
              type="button"
              class="btn btn-primary btn-sm"
              (click)="downloadExcel()"
              title="Exportar a Excel"
            >
              <i class="fas fa-download me-1"></i>
              Exportar
            </button>
            <button
              *hasRole="['admin']"
              type="button"
              class="btn btn-primary btn-sm"
              [routerLink]="['/product-loans/create']"
              title="Crear nuevo préstamo"
            >
              <i class="fas fa-plus me-1"></i>
              Nuevo Préstamo
            </button>
          </div>
        </div>
      </div>
    </c-card-body>
  </c-card>

  <!-- Filtros mejorados -->
  <c-card class="mb-3 filters-card">
    <c-card-header class="bg-light py-2">
      <h6 class="mb-0">
        <i class="fas fa-filter me-2 text-info"></i>
        Filtros de Búsqueda
      </h6>
    </c-card-header>
    <c-card-body class="py-3">
      <form
        [formGroup]="filtersForm"
        (ngSubmit)="onFilter()"
        class="filters-form"
      >
        <div class="row g-2 align-items-end">
          <div class="col-md-2">
            <label for="warehouse" class="form-label small fw-semibold mb-1">
              <i class="fas fa-warehouse me-1 text-muted"></i>
              Bodega
            </label>
            <ng-select
              [items]="warehouseOptions"
              bindLabel="name"
              bindValue="id"
              formControlName="warehouseId"
              [searchable]="true"
              placeholder="Seleccione bodega"
              class="custom-select"
            >
            </ng-select>
          </div>
          
          <div class="col-md-2">
            <label for="startDate" class="form-label small fw-semibold mb-1">
              <i class="fas fa-calendar-alt me-1 text-muted"></i>
              Desde
            </label>
            <input
              type="date"
              id="startDate"
              formControlName="startDate"
              class="form-control form-control-sm"
            />
          </div>

          <div class="col-md-2">
            <label for="endDate" class="form-label small fw-semibold mb-1">
              <i class="fas fa-calendar-alt me-1 text-muted"></i>
              Hasta
            </label>
            <input
              type="date"
              id="endDate"
              formControlName="endDate"
              class="form-control form-control-sm"
            />
          </div>
          
          <div class="col-md-2">
            <label for="status" class="form-label small fw-semibold mb-1">
              <i class="fas fa-tasks me-1 text-muted"></i>
              Estado
            </label>
            <ng-select
              [items]="statusOptions"
              bindLabel="name"
              bindValue="id"
              formControlName="status"
              [searchable]="true"
              placeholder="Seleccione estado"
              class="custom-select"
            >
            </ng-select>
          </div>

          <div class="col-md-4">
            <div class="d-flex gap-1 w-100">
              <button type="submit" class="btn btn-primary btn-sm flex-fill">
                <i class="fas fa-search me-1"></i>
                Buscar
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm flex-fill"
                (click)="resetFilters()"
              >
                <i class="fas fa-times me-1"></i>
                Limpiar
              </button>
            </div>
          </div>
        </div>
      </form>
    </c-card-body>
  </c-card>

  <!-- Contenido principal -->
  <c-card class="main-content-card">
    <c-card-body class="p-0">
      <!-- Resumen de estados -->
      <div class="status-summary p-4">
        <h6 class="mb-2 text-muted small">
          <i class="fas fa-chart-bar me-2"></i>
          Resumen por Estado
        </h6>
        <div class="row g-2">
          <div class="col-md-2 col-sm-4 col-6" *ngFor="let status of productLoanSummary">
            <c-card
              class="status-card text-center h-100"
              [ngClass]="getStatusClass(status.statusName)"
            >
              <c-card-body class="p-2">
                <div class="status-icon mb-1">
                  <i class="fas fa-circle small"></i>
                </div>
                <h6 class="mb-1 status-name small">{{ status.statusName }}</h6>
                <p class="m-0 status-count fw-bold">{{ status.count }}</p>
              </c-card-body>
            </c-card>
          </div>
        </div>
      </div>

      <!-- Tabla de préstamos -->
      <div class="product-loans-table-container p-4">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th scope="col" class="text-center">
                  <i class="fas fa-hashtag text-muted"></i>
                  ID
                </th>
                <th scope="col">
                  <i class="fas fa-warehouse text-muted me-1"></i>
                  Bodega
                </th>
                <th scope="col">
                  <i class="fas fa-calendar text-muted me-1"></i>
                  Fecha
                </th>
                <th scope="col">
                  <i class="fas fa-sticky-note text-muted me-1"></i>
                  Notas
                </th>
                <th scope="col">
                  <i class="fas fa-tasks text-muted me-1"></i>
                  Estado
                </th>
                <th scope="col" class="text-center">
                  <i class="fas fa-cogs text-muted"></i>
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let loan of productLoans" class="align-middle">
                <td class="text-center">
                  <span class="badge bg-secondary">{{ loan.id }}</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-warehouse text-primary me-2"></i>
                    <span class="fw-medium">{{ loan.warehouseName }}</span>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-calendar text-info me-2"></i>
                    <span>{{ loan.loanDate | date:'dd/MM/yyyy' }}</span>
                  </div>
                </td>
                <td>
                  <div class="notes-cell">
                    <span class="text-truncate d-inline-block" style="max-width: 200px;" 
                          [title]="loan.notes">
                      {{ loan.notes || 'Sin notas' }}
                    </span>
                  </div>
                </td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(loan.status)">
                    {{ getStatusDisplayName(loan.status) }}
                  </span>
                </td>
                <td class="text-center">
                  <div class="btn-group" role="group">
                    <button
                      type="button"
                      class="btn btn-outline-primary btn-sm"
                      (click)="viewDetail(loan)"
                      title="Ver detalle"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Mensaje cuando no hay datos -->
        <div *ngIf="productLoans.length === 0" class="text-center py-5">
          <i class="fas fa-inbox text-muted fs-1 mb-3"></i>
          <h5 class="text-muted">No se encontraron préstamos</h5>
          <p class="text-muted small">No hay préstamos que coincidan con los filtros aplicados</p>
        </div>
        
        <!-- Paginación -->
        <div class="pagination-container mt-4" *ngIf="productLoans.length > 0">
          <app-generic-pagination
            [pagination]="pagination"
            [currentPage]="currentPage"
            (pageChange)="onPageChange($event)"
          >
          </app-generic-pagination>
        </div>
      </div>
    </c-card-body>
  </c-card>
</div>

<!-- Modales -->
<app-generic-modal></app-generic-modal>
