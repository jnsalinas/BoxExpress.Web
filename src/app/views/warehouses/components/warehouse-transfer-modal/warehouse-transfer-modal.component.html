<c-modal [visible]="isVisible" size="lg" backdrop="static">
  <c-modal-header>
    <h5 class="modal-title">Transferencia entre Bodegas</h5>
  </c-modal-header>

  <c-modal-body>
    <form [formGroup]="form">
      <div class="mb-3">
        <label for="toWarehouseId" class="form-label"
          >Bodega destino</label
        >
        <ng-select
          id="toWarehouseId"
          placeholder="Selecciona la bodega"
          searchable="false"
          formControlName="toWarehouseId"
          [items]="warehouses"
          bindValue="id"
          bindLabel="name"
          (change)="onWarehouseChange($event)"
        >
        </ng-select>
      </div>

      <div formArrayName="transferDetails">
        <div
          *ngFor="let variant of transferDetails.controls; let i = index"
          [formGroupName]="i"
          class="border rounded p-3 mb-3 bg-light"
        >
          <div class="row g-2 align-items-end">
            <div class="col-md-7">
              <label class="form-label fw-bold">
                Variante <span class="text-danger">*</span>
              </label>
              <ng-select
                class="form-control"
                [items]="getVariantOptions(i)"
                bindLabel="displayName"
                bindValue="id"
                [loading]="isLoadingVariant[i]"
                formControlName="productVariantId"
                (change)="onVariantSelected($event, i)"
                [searchable]="true"
                [typeahead]="variantInputSubjects[i]"
                placeholder="Selecciona variante"
                [virtualScroll]="true"
              ></ng-select>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">
                Cantidad <span class="text-danger">*</span>
              </label>
              <input
                type="number"
                class="form-control"
                formControlName="quantity"
                [attr.min]="1"
                [attr.max]="variant.get('max')?.value"
              />
              <!-- <small class="text-muted" *ngIf="variant.get('max')?.value !== null">
                Disponible: {{ variant.get('max')?.value }}
              </small> -->
            </div>
            <div class="col-md-2 text-end">
              <button
                type="button"
                class="btn btn-danger"
                (click)="removeProductVariant(i)"
                *ngIf="transferDetails.length > 1"
                title="Eliminar variante"
              >
                <svg [cIcon]="icons.cilXCircle"></svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <button
        type="button"
        class="btn btn-outline-primary w-100 mb-4"
        (click)="addProductVariant()"
      >
        <svg [cIcon]="icons.cilPlus"></svg>
        Agregar Variante
      </button>

      <div *ngIf="transferDetails.length === 0" class="alert alert-warning mt-3">
        Debes agregar al menos un producto/variante para transferir.
      </div>

      <div class="mt-4">
        <c-card>
          <c-card-body>
            <h5 class="mb-3">Resumen de la Transferencia</h5>

            <div class="mb-3">
              <strong>Bodega destino:</strong>
              <span>
                {{ selectedWarehouseName }}
              </span>
            </div>

            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Variante</th>
                  <th style="width: 150px">Cantidad</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of summaryList">
                  <td>{{ item.name }}</td>
                  <td>{{ item.quantity }}</td>
                </tr>
              </tbody>
            </table>

            <div
              *ngIf="summaryList.length === 0"
              class="text-center text-muted mt-3"
            >
              No hay variantes agregadas aÃºn.
            </div>
          </c-card-body>
        </c-card>
      </div>
    </form>
  </c-modal-body>

  <c-modal-footer>
    <button type="button" class="btn btn-secondary" (click)="close()">
      Cancelar
    </button>
    <button
      type="button"
      class="btn btn-primary"
      (click)="save()"
      [disabled]="transferDetails.length === 0 || form.invalid"
    >
      Transferir
    </button>
  </c-modal-footer>
</c-modal>
