<c-modal [visible]="true" size="lg" backdrop="static" class="modern-modal">
  <c-modal-header class="modal-header-custom">
    <h5 class="modal-title">
      <div class="d-flex align-items-center">
        <div class="modal-icon me-2">
          <svg [cIcon]="icons.cilHome" size="2xl"></svg>
        </div>
        <div>
          <span class="fw-bold">Transferir a tienda</span>
        </div>
      </div>
    </h5>
  </c-modal-header>

  <c-modal-body class="modal-body-custom">
    <form [formGroup]="form">
      <div formArrayName="transferDetails">
        <div
          *ngFor="let variant of transferDetails.controls; let i = index"
          [formGroupName]="i"
          class="row g-3 align-items-end mb-3 border rounded p-3 bg-light"
        >
          <div class="col-md-4">
            <label class="form-label"
              >Variante <span class="text-danger">*</span></label
            >
            <ng-select
              class="custom-select"
              [items]="getVariantOptions(i)"
              bindLabel="displayName"
              bindValue="id"
              [loading]="isLoadingVariant[i]"
              formControlName="productVariantId"
              (change)="onVariantSelected($event, i)"
              [searchable]="true"
              [typeahead]="variantInputSubjects[i]"
              placeholder="Selecciona variante"
              [virtualScroll]="true"
            ></ng-select>
            
          </div>
          <div class="col-md-4" [ngClass]="{'has-error': transferDetails.at(i)?.errors?.['storesMustDiffer']}">
            <label class="form-label"
              >Tienda <span class="text-danger">*</span></label
            >
            <ng-select
              class="custom-select"
              [items]="stores"
              bindLabel="name"
              bindValue="id"
              formControlName="storeId"
              placeholder="Selecciona tienda"
              [clearable]="false"
              [searchable]="false"
            ></ng-select>
            <div class="text-danger small mt-1" *ngIf="transferDetails.at(i)?.errors?.['storesMustDiffer']">
              La tienda destino debe ser diferente a la tienda de origen.
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label"
              >Cantidad <span class="text-danger">*</span></label
            >
            <input
              type="number"
              class="form-control"
              formControlName="quantity"
              [attr.min]="1"
              [attr.max]="variant.get('max')?.value"
              placeholder="Cantidad"
            />
          </div>
          <div class="col-md-1 d-flex justify-content-end">
            <button
              type="button"
              class="btn btn-outline-danger"
              (click)="removeTransferDetail(i)"
              [disabled]="transferDetails.length === 1"
              title="Eliminar variante"
            >
              <svg [cIcon]="icons.cilTrash" size="sm" class="me-1"></svg>
            </button>
          </div>
          <div class="col-12">
            <div class="d-flex justify-content-between small text-muted px-1">
              <div *ngIf="variant.get('fromStoreName')?.value">
                <i class="fas fa-store me-1"></i>
                {{ variant.get('fromStoreName')?.value }}
              </div>
              <div *ngIf="variant.get('max')?.value !== null">
                <i class="fas fa-info-circle me-1"></i>
                Disponible: {{ variant.get('max')?.value }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <button
        type="button"
        class="btn btn-outline-primary w-100"
        (click)="addTransferDetail()"
      >
        <i class="fas fa-plus me-1"></i>
        Agregar Variante
      </button>
    </form>
  </c-modal-body>

  <c-modal-footer class="modal-footer-custom">
    <div class="d-flex gap-2 w-100">
      <button
        type="button"
        class="btn btn-outline-secondary flex-fill"
        (click)="close()"
        [disabled]="isLoading"
      >
        <i class="fas fa-times me-1"></i>
        Cancelar
      </button>
      <button
        type="button"
        class="btn btn-primary flex-fill"
        (click)="save()"
        [disabled]="form.invalid || isLoading"
      >
        <span
          *ngIf="isLoading"
          class="spinner-border spinner-border-sm me-2"
        ></span>
        <i class="fas fa-save me-1" *ngIf="!isLoading"></i>
        {{ isLoading ? "Creando..." : "Transferir a tienda" }}
      </button>
    </div>
  </c-modal-footer>
</c-modal>
