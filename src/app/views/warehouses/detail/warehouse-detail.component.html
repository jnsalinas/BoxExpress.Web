<app-loading-overlay
  *ngIf="isLoading"
  [loadingText]="'Cargando detalle...'"
></app-loading-overlay>
<c-row>
  <c-col xs="12">
    <c-card class="mb-3">
      <c-card-header>
        <strong>Bodega:</strong> {{ warehouseDetail?.name }}
        <div class="d-flex justify-content-end gap-2" *hasRole="['admin']">
          <button class="btn btn-sm btn-primary" (click)="openInventoryModal()">
            Agregar productos
          </button>
          <button class="btn btn-sm btn-primary" (click)="openTransferModal()">
            Transferir productos
          </button>
        </div>
      </c-card-header>
      <c-card-body>
        <div class="input-group mb-3 justify-content-end">
          <form
            [formGroup]="filtersForm"
            (ngSubmit)="onFilter()"
            class="d-flex w-100 align-items-center gap-2 mb-3"
          >
            <span class="input-group-text">üîç</span>

            <input
              type="text"
              class="form-control flex-grow-1"
              placeholder="Buscar producto"
              formControlName="query"
            />

            <button type="submit" class="btn btn-primary">Filtrar</button>

            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="resetFilters()"
            >
              Limpiar
            </button>
          </form>
        </div>

        <ng-template #actions let-variant>
          <span>
            <a
              class="btn btn-sm btn-outline-primary"
              [routerLink]="['/warehouses', warehouseDetail?.id, 'inventory', variant.warehouseInventoryId]"
            >
              Ver historial
            </a>
          </span>
          <a
            *hasRole="['admin']"
            class="btn btn-sm btn-outline-primary"
            (click)="openInventoryItemModal(variant)"
            >Editar</a
          >
        </ng-template>

        <app-inventory-table
          [products]="filteredProducts || []"
          [showActions]="authService.hasRole('admin')"
          [showStore]="true"
          [pagination]="pagination"
          [currentPage]="currentPage"
          (pageChange)="onPageChange($event)"
          [actionsTemplate]="actions"
          (addVariant)="onAddVariant($event)"
        >
        </app-inventory-table>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<app-warehouse-product-modal
  *ngIf="warehouseDetail"
  [warehouseId]="warehouseDetail.id"
  [warehouseName]="warehouseDetail.name"
  [isVisible]="isModalInventoryVisible"
  [productToEdit]="productToEdit"
  (onSave)="handleInventorySave($event)"
  (onClose)="handleInventoryClose($event)"
>
</app-warehouse-product-modal>

<app-warehouse-transfer-modal
  *ngIf="warehouseDetail"
  [isVisible]="isModalTransferVisible"
  [warehouseId]="warehouseDetail.id"
  (onSave)="handleTransferSave($event)"
  (onClose)="handleTransferClose($event)"
>
</app-warehouse-transfer-modal>
<app-generic-modal></app-generic-modal>

<app-warehouse-inventory-item-edit-modal
  *ngIf="warehouseInventoryId"
  [warehouseInventoryId]="warehouseInventoryId"
  (onSave)="handleInventoryItemSave($event)"
  (onClose)="handleInventoryItemClose()"
></app-warehouse-inventory-item-edit-modal>
<!-- todo: mirar si este modal se puede poner en el router outlet en el template  -->
