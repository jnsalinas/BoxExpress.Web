<app-loading-overlay
  *ngIf="isLoading"
  [loadingText]="'Cargando detalle...'"
></app-loading-overlay>

<div *ngIf="!isLoading" class="warehouse-detail-container">
  <c-card class="mb-3 stats-header-card">
    <c-card-body class="p-3">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="d-flex align-items-center">
            <div class="warehouse-icon me-3">
              <svg [cIcon]="icons.cilHome" size="sm" class="text-primary"></svg>
            </div>
            <div>
              <h3 class="mb-1 text-primary">
                Bodega: {{ warehouseDetail?.name }}
              </h3>
              <p class="text-muted mb-0 small">
                Gestión de inventario y productos de la bodega
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <div class="action-buttons d-flex gap-2">
            <button
              class="btn btn-primary btn-sm"
              (click)="openInventoryModal()"
              title="Nuevo producto"
            >
              <svg [cIcon]="icons.cilPlus" size="sm" class="me-1"></svg>
              Nuevo producto
            </button>
            <button
              class="btn btn-primary btn-sm"
              (click)="openTransferModal()"
              title="Transferir productos"
            >
              <svg [cIcon]="icons.cilArrowRight" size="sm" class="me-1"></svg>
              Transferir productos
            </button>
            <button
            class="btn btn-primary btn-sm"
            (click)="openTransferStoreModal()"
            title="Transferir a tienda"
          >
            <svg [cIcon]="icons.cilArrowRight" size="sm" class="me-1"></svg>
            Transferir a tienda
          </button>
          </div>
        </div>
      </div>
    </c-card-body>
  </c-card>

  <!-- Filtros mejorados -->
  <c-card class="mb-3 filters-card">
    <c-card-header class="bg-light py-2">
      <h6 class="mb-0">
        <svg [cIcon]="icons.cilFilter" size="sm" class="me-2 text-info"></svg>
        Filtros de Búsqueda
      </h6>
    </c-card-header>
    <c-card-body class="py-3">
      <form [formGroup]="filtersForm" class="filters-form">
        <div class="row g-2 align-items-end">
          <div class="col-md-8">
            <label for="query" class="form-label small fw-semibold mb-1">
              <svg
                [cIcon]="icons.cilSearch"
                size="sm"
                class="me-1 text-muted"
              ></svg>
              Buscar producto
            </label>
            <input
              type="text"
              id="query"
              formControlName="query"
              class="form-control form-control-sm"
              placeholder="Nombre del producto o SKU"
            />
          </div>
          <div class="col-md-4">
            <div class="d-flex gap-1 w-100">
              <button type="submit" class="btn btn-primary btn-sm flex-fill">
                <svg [cIcon]="icons.cilSearch" size="sm" class="me-1"></svg>
                Filtrar
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm flex-fill"
                (click)="resetFilters()"
              >
                <svg [cIcon]="icons.cilX" size="sm" class="me-1"></svg>
                Limpiar
              </button>
            </div>
          </div>
        </div>
      </form>
    </c-card-body>
  </c-card>

  <!-- Contenido principal -->
  <c-card class="main-content-card">
    <c-card-body class="p-0">
      <div class="inventory-table-container p-4">
        <ng-template #actions let-variant>
          <div class="d-flex gap-1">
            <a
              class="btn btn-sm btn-outline-primary"
              [routerLink]="[
                '/warehouses',
                warehouseDetail?.id,
                'inventory',
                variant.warehouseInventoryId
              ]"
              title="Ver historial"
            >
              <svg [cIcon]="icons.cilHistory" size="sm" class="me-1"></svg>
              Ver historial
            </a>
            <!-- <a
              *hasRole="['admin', 'supervisor']"
              class="btn btn-sm btn-outline-primary"
              (click)="openInventoryItemModal(variant)"
              title="Ver historial"
            >
              <svg [cIcon]="icons.cilPencil" size="sm" class="me-1"></svg>
              Editar
            </a> -->
          </div>
        </ng-template>

        <app-inventory-table
          [products]="filteredProducts || []"
          [showActions]="authService.hasAnyRole(['admin', 'supervisor', 'bodega'])"
          [showStore]="true"
          [pagination]="pagination"
          [currentPage]="currentPage"
          (pageChange)="onPageChange($event)"
          [actionsTemplate]="actions"
          (addVariant)="onAddVariant($event)"
          (refreshData)="onRefreshData()"
        >
        </app-inventory-table>
      </div>
    </c-card-body>
  </c-card>
</div>

<app-warehouse-product-modal
  *ngIf="warehouseDetail"
  [warehouseId]="warehouseDetail.id"
  [warehouseName]="warehouseDetail.name"
  [isVisible]="isModalInventoryVisible"
  [productToEdit]="productToEdit"
  (onSave)="handleInventorySave($event)"
  (onClose)="handleInventoryClose($event)"
>
</app-warehouse-product-modal>

<app-warehouse-transfer-modal
  *ngIf="warehouseDetail"
  [isVisible]="isModalTransferVisible"
  [warehouseId]="warehouseDetail.id"
  (onSave)="handleTransferSave($event)"
  (onClose)="handleTransferClose($event)"
>
</app-warehouse-transfer-modal>

<app-warehouse-transfer-store-modal
  *ngIf="isModalTransferStoreVisible"
  [isVisible]="isModalTransferStoreVisible"
  (onSave)="handleTransferStoreSave($event)"
  (onClose)="handleTransferStoreClose($event)"
>
</app-warehouse-transfer-store-modal>

<app-generic-modal></app-generic-modal>
