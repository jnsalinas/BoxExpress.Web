<app-loading-overlay
  *ngIf="isLoading"
  [loadingText]="'Cargando detalle...'"
></app-loading-overlay>

<div *ngIf="!isLoading" class="warehouse-detail-container">
  <!-- Header con estadísticas estilo gestión de órdenes -->
  <c-card class="mb-3 stats-header-card">
    <c-card-body class="p-3">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="d-flex align-items-center">
            <div class="warehouse-icon me-3">
              <i class="fas fa-warehouse text-primary fs-3"></i>
            </div>
            <div>
              <h3 class="mb-1 text-primary">Bodega: {{ warehouseDetail?.name }}</h3>
              <p class="text-muted mb-0 small">Gestión de inventario y productos de la bodega</p>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <div class="action-buttons d-flex gap-2">
            <button 
              class="btn btn-primary btn-sm" 
              (click)="openInventoryModal()"
              title="Agregar productos"
            >
              <i class="fas fa-plus me-1"></i>
              Agregar productos
            </button>
            <button 
              class="btn btn-primary btn-sm" 
              (click)="openTransferModal()"
              title="Transferir productos"
            >
              <i class="fas fa-exchange-alt me-1"></i>
              Transferir productos
            </button>
          </div>
        </div>
      </div>
    </c-card-body>
  </c-card>

  <!-- Filtros mejorados -->
  <c-card class="mb-3 filters-card">
    <c-card-header class="bg-light py-2">
      <h6 class="mb-0">
        <i class="fas fa-filter me-2 text-info"></i>
        Filtros de Búsqueda
      </h6>
    </c-card-header>
    <c-card-body class="py-3">
      <form [formGroup]="filtersForm" class="filters-form">
        <div class="row g-2 align-items-end">
          <div class="col-md-8">
            <label for="query" class="form-label small fw-semibold mb-1">
              <i class="fas fa-search me-1 text-muted"></i>
              Buscar producto
            </label>
            <input
              type="text"
              id="query"
              formControlName="query"
              class="form-control form-control-sm"
              placeholder="Nombre del producto o SKU"
            />
          </div>
          <div class="col-md-4">
            <div class="d-flex gap-1 w-100">
              <button type="submit" class="btn btn-primary btn-sm flex-fill">
                <i class="fas fa-search me-1"></i>
                Filtrar
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm flex-fill"
                (click)="resetFilters()"
              >
                <i class="fas fa-times me-1"></i>
                Limpiar
              </button>
            </div>
          </div>
        </div>
      </form>
    </c-card-body>
  </c-card>

  <!-- Contenido principal -->
  <c-card class="main-content-card">
    <c-card-body class="p-0">
      <div class="inventory-table-container p-4">
        <ng-template #actions let-variant>
          <div class="d-flex gap-1">
            <a
              class="btn btn-sm btn-outline-primary"
              [routerLink]="['/warehouses', warehouseDetail?.id, 'inventory', variant.warehouseInventoryId]"
              title="Ver historial"
            >
              <i class="fas fa-history me-1"></i>
              Ver historial
            </a>
            <a
            *hasRole="['admin']"
            class="btn btn-sm btn-outline-primary"
            (click)="openInventoryItemModal(variant)"
            title="Ver historial"
          >
            <i class="fas fa-edit me-1"></i>
            Editar
          </a>
          </div>
        </ng-template>

        <app-inventory-table
          [products]="filteredProducts || []"
          [showActions]="authService.hasRole('admin')"
          [showStore]="true"
          [pagination]="pagination"
          [currentPage]="currentPage"
          (pageChange)="onPageChange($event)"
          [actionsTemplate]="actions"
          (addVariant)="onAddVariant($event)"
        >
        </app-inventory-table>
      </div>
    </c-card-body>
  </c-card>
</div>

<app-warehouse-product-modal
  *ngIf="warehouseDetail"
  [warehouseId]="warehouseDetail.id"
  [warehouseName]="warehouseDetail.name"
  [isVisible]="isModalInventoryVisible"
  [productToEdit]="productToEdit"
  (onSave)="handleInventorySave($event)"
  (onClose)="handleInventoryClose($event)"
>
</app-warehouse-product-modal>

<app-warehouse-transfer-modal
  *ngIf="warehouseDetail"
  [isVisible]="isModalTransferVisible"
  [warehouseId]="warehouseDetail.id"
  (onSave)="handleTransferSave($event)"
  (onClose)="handleTransferClose($event)"
>
</app-warehouse-transfer-modal>

<app-generic-modal></app-generic-modal>

<app-warehouse-inventory-item-edit-modal
  *ngIf="warehouseInventoryId"
  [warehouseInventoryId]="warehouseInventoryId"
  (onSave)="handleInventoryItemSave($event)"
  (onClose)="handleInventoryItemClose()"
></app-warehouse-inventory-item-edit-modal>
