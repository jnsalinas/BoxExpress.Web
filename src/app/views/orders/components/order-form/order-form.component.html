<app-loading-overlay
  *ngIf="isLoading"
  [loadingText]="'Cargando opciones...'"
></app-loading-overlay>

<c-row>
  <c-col xs="12">
    <c-card class="mb-4">
      <c-card-header><strong>{{ isEditMode ? 'Editar Orden' : 'Crear Orden' }}</strong></c-card-header>
      <c-card-body>
        <form cForm [formGroup]="form" (ngSubmit)="onSubmit()">
          <!-- CLIENTE -->
          <c-card class="mb-4 shadow-sm border-0">
            <c-card-header class="bg-light"
              ><strong>Datos del Cliente</strong></c-card-header
            >
            <c-card-body>
              <c-row>
                <!-- Fila 1: Nombre y Apellido -->
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="clientFirstName"
                      >Nombre <span class="text-danger">*</span></label
                    >
                    <input
                      cFormControl
                      id="clientFirstName"
                      formControlName="clientFirstName"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('clientFirstName')"
                      placeholder="Nombre del cliente"
                    />
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('clientFirstName')">
                      {{ getFieldError('clientFirstName') }}
                    </div>
                  </div>
                </c-col>
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="clientLastName"
                      >Apellido <span class="text-danger">*</span></label
                    >
                    <input
                      cFormControl
                      id="clientLastName"
                      formControlName="clientLastName"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('clientLastName')"
                      placeholder="Apellido del cliente"
                    />
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('clientLastName')">
                      {{ getFieldError('clientLastName') }}
                    </div>
                  </div>
                </c-col>
              </c-row>
              <c-row>
                <!-- Fila 3: Phone -->
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="clientEmail">Teléfono <span class="text-danger">*</span></label>
                    <input
                      cFormControl
                      id="clientPhone"
                      formControlName="clientPhone"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('clientPhone')"
                      type="number"
                      placeholder="Teléfono del cliente"
                    />
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('clientPhone')">
                      {{ getFieldError('clientPhone') }}
                    </div>
                  </div>
                </c-col>
                <!-- Fila 3: Email y External ID -->
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="clientEmail">Email </label>
                    <input
                      cFormControl
                      id="clientEmail"
                      formControlName="clientEmail"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('clientEmail')"
                      type="email"
                      placeholder="Correo electrónico"
                    />
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('clientEmail')">
                      {{ getFieldError('clientEmail') }}
                    </div>
                  </div>
                </c-col>
              </c-row>
            </c-card-body>
          </c-card>

          <hr class="my-4" />

          <!-- DIRECCIÓN -->
          <c-card class="mb-4 shadow-sm border-0">
            <c-card-header class="bg-light"
              ><strong>Dirección de Entrega</strong></c-card-header
            >
            <c-card-body>
              <c-row>
                <!-- Dirección y Complemento en la misma fila -->
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="clientAddress"
                      >Dirección <span class="text-danger">*</span></label
                    >
                    <input
                      cFormControl
                      id="clientAddress"
                      formControlName="clientAddress"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('clientAddress')"
                      placeholder="Dirección principal"
                    />
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('clientAddress')">
                      {{ getFieldError('clientAddress') }}
                    </div>
                  </div>
                </c-col>
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="clientAddressComplement"
                      >Colonia<span class="text-danger">*</span></label
                    >
                    <input
                      cFormControl
                      id="clientAddressComplement"
                      formControlName="clientAddressComplement"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('clientAddressComplement')"
                    />
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('clientAddressComplement')">
                      {{ getFieldError('clientAddressComplement') }}
                    </div>
                  </div>
                </c-col>
              </c-row>
              <c-row>
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="cityId">Ciudad <span class="text-danger">*</span></label>
                    <ng-select
                      [items]="cities"
                      bindLabel="name"
                      bindValue="id"
                      formControlName="cityId"
                      [class.is-invalid]="isFieldInvalid('cityId')"
                      placeholder="Ciudad"
                    ></ng-select>
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('cityId')">
                      {{ getFieldError('cityId') }}
                    </div>
                  </div>
                </c-col>
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="postalCode">Código postal</label>
                    <input
                      cFormControl
                      id="postalCode"
                      formControlName="postalCode"
                      class="form-control"
                    />
                  </div>
                </c-col>
              </c-row>
              <!-- Sección de Coordenadas -->
              <c-card class="mb-4 shadow-sm">
                <c-card-header class="bg-light">
                  <div class="d-flex align-items-center">
                    <!-- <svg [cIcon]="icons.cilLocationPin" class="me-2 text-primary"></svg> -->
                    <h6 class="mb-0 text-primary">
                      ¿Tienes las coordenadas exactas?
                    </h6>
                  </div>
                  <small class="text-muted"
                    >Opcional - Ayuda a mejorar la precisión de la
                    entrega</small
                  >
                </c-card-header>
                <c-card-body>
                  <c-row>
                    <c-col md="6">
                      <div class="mb-3">
                        <label cLabel for="latitude" class="fw-semibold">
                          <!-- <svg [cIcon]="icons.cilLocationPin" class="me-1 text-success"></svg> -->
                          Latitud
                        </label>
                        <div class="input-group">
                          <span class="input-group-text">
                            <!-- <svg [cIcon]="icons.cilLocationPin" class="text-success"></svg> -->
                          </span>
                          <input
                            cFormControl
                            id="latitude"
                            formControlName="latitude"
                            class="form-control"
                            type="number"
                            step="any"
                            placeholder="Ej: 4.60971"
                          />
                        </div>
                        <small class="text-muted"
                          >Coordenada norte-sur del punto de entrega</small
                        >
                      </div>
                    </c-col>
                    <c-col md="6">
                      <div class="mb-3">
                        <label cLabel for="longitude" class="fw-semibold">
                          <!-- <svg [cIcon]="icons.cilLocationPin" class="me-1 text-info"></svg> -->
                          Longitud
                        </label>
                        <div class="input-group">
                          <span class="input-group-text">
                            <!-- <svg [cIcon]="icons.cilLocationPin" class="text-info"></svg> -->
                          </span>
                          <input
                            cFormControl
                            id="longitude"
                            formControlName="longitude"
                            class="form-control"
                            type="number"
                            step="any"
                            placeholder="Ej: -74.08175"
                          />
                        </div>
                        <small class="text-muted"
                          >Coordenada este-oeste del punto de entrega</small
                        >
                      </div>
                    </c-col>
                  </c-row>
                </c-card-body>
              </c-card>
            </c-card-body>
          </c-card>

          <hr class="my-4" />

          <!-- ORDEN -->
          <c-card class="mb-4 shadow-sm border-0">
            <c-card-header class="bg-light"
              ><strong>Información de la Orden</strong></c-card-header
            >
            <c-card-body>
              <c-row>
                <!-- Tienda y Moneda -->
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="storeId"
                      >Tienda <span class="text-danger">*</span></label
                    >
                    <ng-select
                      [items]="stores"
                      bindLabel="name"
                      bindValue="id"
                      formControlName="storeId"
                      [class.is-invalid]="isFieldInvalid('storeId')"
                      placeholder="Seleccione"
                      (change)="onStoreChange($event?.id)"
                    ></ng-select>
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('storeId')">
                      {{ getFieldError('storeId') }}
                    </div>
                    <small class="text-muted"
                      >Al cambiar la tienda, se actualizarán las variantes de
                      producto disponibles.</small
                    >
                  </div>
                </c-col>
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="currencyId"
                      >Moneda <span class="text-danger">*</span></label
                    >
                    <select
                      cFormControl
                      id="currencyId"
                      formControlName="currencyId"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('currencyId')"
                    >
                      <option value="" disabled selected>Seleccione</option>
                      <option
                        *ngFor="let currency of currencies"
                        [value]="currency.id"
                      >
                        {{ currency.name }}
                      </option>
                    </select>
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('currencyId')">
                      {{ getFieldError('currencyId') }}
                    </div>
                  </div>
                </c-col>
              </c-row>
              <c-row>
                <!-- Fee y Código -->
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="deliveryFee"
                      >Flete <span class="text-danger">*</span></label
                    >
                    <input
                      cFormControl
                      id="deliveryFee"
                      formControlName="deliveryFee"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('deliveryFee')"
                      type="number"
                      placeholder="Costo de envío"
                    />
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('deliveryFee')">
                      {{ getFieldError('deliveryFee') }}
                    </div>
                  </div>
                </c-col>
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="code">Código</label>
                    <input
                      cFormControl
                      formControlName="code"
                      id="code"
                      type="text"
                      class="form-control"
                      placeholder="Código interno de tu tienda si tienes"
                    />
                  </div>
                </c-col>
              </c-row>
              <c-row>
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="notes">Notas</label>
                    <textarea
                      cFormControl
                      formControlName="notes"
                      id="notes"
                      class="form-control"
                      rows="3"
                      placeholder="Notas adicionales (opcional)"
                    ></textarea>
                  </div>
                </c-col>
                <c-col md="6">
                  <div class="mb-3">
                    <label cLabel for="totalAmount"
                      >Valor a cobrar <span class="text-danger">*</span></label
                    >
                    <input
                      cFormControl
                      formControlName="totalAmount"
                      id="totalAmount"
                      type="number"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('totalAmount')"
                      placeholder="Valor total de la orden"
                    />
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('totalAmount')">
                      {{ getFieldError('totalAmount') }}
                    </div>
                  </div>
                </c-col>
              </c-row>
            </c-card-body>
          </c-card>

          <hr class="my-4" />

          <!-- Productos -->
          <c-card class="mb-4 shadow-sm border-0">
            <c-card-header class="bg-light"
              ><strong>Productos</strong></c-card-header
            >
            <c-card-body>
              <div
                *ngIf="productVariants.length === 0"
                class="alert alert-info mb-3"
              >
                Selecciona una tienda para ver las variantes de producto
                disponibles.
              </div>
              <div *ngIf="isFormArrayInvalid('orderItems')" class="alert alert-danger mb-3">
                {{ getFormArrayError('orderItems') }}
              </div>
              <div
                *ngFor="let item of orderItems.controls; let i = index"
                [formGroup]="getOrderItemFormGroup(i)"
                class="border p-3 mb-2 rounded bg-light-subtle"
              >
                <c-row class="d-flex align-items-end g-2">
                  <c-col md="7">
                    <label class="mb-0"
                      >Variante <span class="text-danger">*</span></label
                    >
                    <ng-select
                      formControlName="productVariantId"
                      [items]="productVariants"
                      bindLabel="displayName"
                      bindValue="id"
                      placeholder="Seleccione"
                      [searchable]="true"
                      [clearable]="false"
                      [class.is-invalid]="isOrderItemFieldInvalid(i, 'productVariantId')"
                    ></ng-select>
                    <div class="invalid-feedback" *ngIf="isOrderItemFieldInvalid(i, 'productVariantId')">
                      {{ getOrderItemFieldError(i, 'productVariantId') }}
                    </div>
                    <small class="text-muted d-block mt-1"
                      >Solo se muestran variantes con inventario disponible en
                      la tienda seleccionada.</small
                    >
                  </c-col>
                  <c-col md="3">
                    <label class="mb-0"
                      >Cantidad <span class="text-danger">*</span></label
                    >
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      formControlName="quantity"
                      [class.is-invalid]="isOrderItemFieldInvalid(i, 'quantity')"
                      placeholder="Cantidad"
                      style="height: 32px"
                    />
                    <div class="invalid-feedback" *ngIf="isOrderItemFieldInvalid(i, 'quantity')">
                      {{ getOrderItemFieldError(i, 'quantity') }}
                    </div>
                    <small class="text-muted"
                      >Máximo: {{ getVariantMaxQuantity(item) }}</small
                    >
                  </c-col>
                  <c-col md="2" class="text-end">
                    <label class="d-block mb-0">&nbsp;</label>
                    <button
                      cButton
                      type="button"
                      color="danger"
                      (click)="removeItem(i)"
                    >
                      Eliminar
                    </button>
                  </c-col>
                </c-row>
              </div>
              <button
                cButton
                type="button"
                color="primary"
                (click)="addItem()"
                [disabled]="productVariants.length === 0"
              >
                Agregar producto
              </button>
            </c-card-body>
          </c-card>

          <div class="mt-4 text-end">
            <button
              cButton
              type="submit"
              color="success"
            >
              {{ isEditMode ? 'Actualizar Orden' : 'Guardar Orden' }}
            </button>
          </div>
        </form>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>
